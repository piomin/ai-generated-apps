version: 2.1

orbs:
  maven: circleci/maven@1.4.1

jobs:
  build:
    docker:
      - image: cimg/openjdk:25.0
    resource_class: large
    steps:
      - checkout
      - restore_cache:
          keys:
            - v1-dependencies-{{ checksum "pom.xml" }}
            - v1-dependencies-
      - run:
          name: Build with Maven
          command: mvn clean package -DskipTests
      - save_cache:
          paths:
            - ~/.m2
          key: v1-dependencies-{{ checksum "pom.xml" }}
      - persist_to_workspace:
          root: .
          paths:
            - target
            - pom.xml

  test:
    docker:
      - image: cimg/openjdk:25.0
    resource_class: large
    steps:
      - checkout
      - restore_cache:
          keys:
            - v1-dependencies-{{ checksum "pom.xml" }}
            - v1-dependencies-
      - setup_remote_docker:
          version: 20.10.24
          docker_layer_caching: true
      - run:
          name: Run Tests
          command: mvn test
      - store_test_results:
          path: target/surefire-reports
      - store_artifacts:
          path: target/surefire-reports

  deploy-test:
    machine:
      image: ubuntu-2404:current
    resource_class: large
    steps:
      - checkout
      - attach_workspace:
          at: .
      - run:
          name: Install Java 25
          command: |
            wget https://download.oracle.com/java/25/latest/jdk-25_linux-x64_bin.tar.gz
            sudo mkdir -p /opt/java
            sudo tar -xzf jdk-25_linux-x64_bin.tar.gz -C /opt/java
            echo 'export JAVA_HOME=/opt/java/jdk-25' >> $BASH_ENV
            echo 'export PATH=$JAVA_HOME/bin:$PATH' >> $BASH_ENV
            source $BASH_ENV
            java -version
      - run:
          name: Install Kind
          command: |
            curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.25.0/kind-linux-amd64
            chmod +x ./kind
            sudo mv ./kind /usr/local/bin/kind
      - run:
          name: Install kubectl
          command: |
            curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
            chmod +x kubectl
            sudo mv kubectl /usr/local/bin/
      - run:
          name: Install Skaffold
          command: |
            curl -Lo skaffold https://storage.googleapis.com/skaffold/releases/latest/skaffold-linux-amd64
            chmod +x skaffold
            sudo mv skaffold /usr/local/bin/
      - run:
          name: Create Kind Cluster
          command: |
            kind create cluster --name test-cluster --wait 5m
            kubectl cluster-info --context kind-test-cluster
      - run:
          name: Deploy with Skaffold
          command: |
            skaffold run --default-repo=local --port-forward=false
          no_output_timeout: 20m
      - run:
          name: Wait for Deployment
          command: |
            kubectl wait --for=condition=ready pod -l app=postgres --timeout=300s
            kubectl wait --for=condition=ready pod -l app=sample-spring-boot-app --timeout=300s
      - run:
          name: Verify Deployment
          command: |
            kubectl get pods
            kubectl get services
            kubectl logs -l app=sample-spring-boot-app --tail=50
      - run:
          name: Cleanup
          command: kind delete cluster --name test-cluster
          when: always

workflows:
  version: 2
  build-test-deploy:
    jobs:
      - build
      - test:
          requires:
            - build
      - deploy-test:
          requires:
            - test
